name: DB 마이그레이션

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: 마이그레이션 실행
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          python3 - <<'EOF'
import urllib.request
import json
import os
import sys

token = os.environ.get("SUPABASE_ACCESS_TOKEN", "")
if not token:
    print("오류: SUPABASE_ACCESS_TOKEN secret이 없습니다.")
    sys.exit(1)

project_ref = "unuvbdqjgiypxfvlplpd"

sql = """
ALTER TABLE agent_settings ADD COLUMN IF NOT EXISTS kstartup_keywords TEXT DEFAULT '';
ALTER TABLE user_profile DISABLE ROW LEVEL SECURITY;
"""

payload = json.dumps({"query": sql}).encode()
req = urllib.request.Request(
    f"https://api.supabase.com/v1/projects/{project_ref}/database/query",
    data=payload,
    headers={
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json",
    },
    method="POST",
)
try:
    with urllib.request.urlopen(req, timeout=30) as resp:
        result = json.loads(resp.read().decode())
        print(f"완료: {result}")
except urllib.error.HTTPError as e:
    print(f"오류 ({e.code}): {e.read().decode()}", file=sys.stderr)
    sys.exit(1)
EOF
