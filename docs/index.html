<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>에이전트 설정</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
      padding: 32px 16px;
    }

    .container { max-width: 660px; margin: 0 auto; }

    h1 { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
    .subtitle { font-size: 14px; color: #666; margin-bottom: 28px; }

    /* 공통 카드 */
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
    }

    .card-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: #999;
      margin-bottom: 16px;
    }

    /* 에이전트 카드 */
    .agent-card {
      background: #fff;
      border-radius: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
      overflow: hidden;
    }
    .agent-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px;
      border-bottom: 1px solid #f0f0f0;
    }
    .agent-card-header.news  { border-top: 4px solid #0071e3; }
    .agent-card-header.kstartup { border-top: 4px solid #30b94a; }

    .agent-name {
      font-size: 16px;
      font-weight: 700;
    }
    .agent-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
      margin-left: 8px;
      vertical-align: middle;
    }
    .badge-news { background: #e8f0fe; color: #0071e3; }
    .badge-kstartup { background: #e6f8ea; color: #1d8a32; }

    .agent-card-body { padding: 20px 24px; }

    .section-divider {
      height: 1px;
      background: #f0f0f0;
      margin: 20px 0;
    }

    .section-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #bbb;
      margin-bottom: 12px;
    }

    /* 폼 */
    label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; }

    input[type="text"], input[type="password"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d1d6;
      border-radius: 10px;
      font-size: 14px;
      color: #1d1d1f;
      background: #fafafa;
      outline: none;
      transition: border-color .15s;
    }
    input[type="text"]:focus, input[type="password"]:focus,
    select:focus, textarea:focus {
      border-color: #0071e3;
      background: #fff;
    }
    textarea { resize: vertical; min-height: 140px; font-family: inherit; line-height: 1.6; }

    .field { margin-bottom: 14px; }
    .field:last-child { margin-bottom: 0; }

    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* 토글 */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .toggle-label { font-size: 14px; font-weight: 500; }
    .toggle-desc { font-size: 12px; color: #999; margin-top: 2px; }

    .switch { position: relative; width: 48px; height: 28px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; inset: 0;
      background: #d1d1d6;
      border-radius: 28px;
      cursor: pointer;
      transition: background .2s;
    }
    .slider::before {
      content: '';
      position: absolute;
      left: 3px; top: 3px;
      width: 22px; height: 22px;
      background: #fff;
      border-radius: 50%;
      transition: transform .2s;
      box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    input:checked + .slider { background: #34c759; }
    input:checked + .slider::before { transform: translateX(20px); }

    /* 소스 리스트 */
    .source-list { display: flex; flex-direction: column; gap: 8px; }
    .source-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 14px;
      background: #f5f5f7;
      border-radius: 10px;
    }
    .source-name { font-size: 14px; font-weight: 500; }

    /* 버튼 */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 11px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity .15s, transform .1s;
    }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: #0071e3; color: #fff; }
    .btn-primary:hover { opacity: .88; }
    .btn-run-news { background: #0071e3; color: #fff; opacity: .85; }
    .btn-run-news:hover { opacity: 1; }
    .btn-run-kstartup { background: #30b94a; color: #fff; }
    .btn-run-kstartup:hover { opacity: .88; }
    .btn-secondary { background: transparent; color: #0071e3; border: 1px solid #0071e3; }
    .btn-danger { background: transparent; color: #ff3b30; border: 1px solid #ff3b30; }
    .btn:disabled { opacity: .45; cursor: not-allowed; transform: none; }
    .btn-full { width: 100%; }

    .action-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
      padding-top: 18px;
      border-top: 1px solid #f0f0f0;
    }

    .bottom-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* 토스트 */
    .toast {
      position: fixed;
      bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #1d1d1f;
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: transform .3s, opacity .3s;
      white-space: nowrap;
      z-index: 100;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { background: #ff3b30; }

    .hint { font-size: 12px; color: #aaa; margin-top: 5px; }

    #loading {
      text-align: center;
      padding: 48px;
      color: #888;
      font-size: 15px;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="container">
  <h1>에이전트 설정</h1>
  <p class="subtitle">변경사항은 Supabase에 저장됩니다</p>

  <!-- 연결 설정 -->
  <div id="setup-card" class="card hidden">
    <div class="card-title">연결 설정</div>
    <div class="field">
      <label>Supabase Project URL</label>
      <input type="text" id="sb-url" placeholder="https://xxxx.supabase.co">
    </div>
    <div class="field">
      <label>Supabase Anon Key</label>
      <input type="password" id="sb-key" placeholder="sb_publishable_...">
      <p class="hint">Supabase → Settings → API Keys → sb_publishable_ 키</p>
    </div>
    <div class="field">
      <label>GitHub Personal Access Token</label>
      <input type="password" id="gh-token" placeholder="ghp_...">
      <p class="hint">GitHub → Settings → Developer settings → Personal access tokens → <b>workflow</b> 권한 필요</p>
    </div>
    <button class="btn btn-primary btn-full" onclick="connect()">연결하기</button>
  </div>

  <div id="loading">불러오는 중...</div>

  <!-- 설정 패널 -->
  <div id="settings-panel" class="hidden">

    <!-- ───────────────────────────── 뉴스 에이전트 ───────────────────────────── -->
    <div class="agent-card">
      <div class="agent-card-header news">
        <div>
          <span class="agent-name">뉴스 아이디어 에이전트</span>
          <span class="agent-badge badge-news">매 시간</span>
        </div>
        <label class="switch" title="에이전트 활성화/비활성화">
          <input type="checkbox" id="news-enabled">
          <span class="slider"></span>
        </label>
      </div>

      <div class="agent-card-body">

        <!-- 실행 주기 -->
        <div class="section-label">실행 주기</div>
        <div class="field">
          <select id="run-every-hours">
            <option value="1">매 시간 (1시간)</option>
            <option value="2">2시간마다</option>
            <option value="3">3시간마다</option>
            <option value="6">6시간마다</option>
            <option value="12">12시간마다</option>
            <option value="24">하루 1회 (자정 UTC)</option>
          </select>
          <p class="hint">GitHub Actions는 매 시간 체크하며, 설정한 간격에 맞지 않으면 건너뜁니다</p>
        </div>

        <div class="section-divider"></div>

        <!-- 뉴스 소스 -->
        <div class="section-label">뉴스 소스</div>
        <div class="source-list" id="source-list"></div>

        <div class="section-divider"></div>

        <!-- 프롬프트 -->
        <div class="section-label">AI 프롬프트 템플릿</div>
        <div class="field">
          <textarea id="prompt-template" placeholder="비워두면 기본 프롬프트를 사용합니다.

{news_block} 위치에 수집된 뉴스가 삽입됩니다.
예시:
당신은 스타트업 투자자입니다.
아래 뉴스를 보고 투자 기회를 찾아주세요.

{news_block}

투자 관점에서 분석해주세요."></textarea>
          <p class="hint">{news_block} 위치에 수집된 뉴스가 삽입됩니다. 비워두면 기본 프롬프트 사용</p>
        </div>

        <!-- 뉴스 에이전트 액션 -->
        <div class="action-row">
          <button class="btn btn-primary" onclick="saveNewsSettings()">설정 저장</button>
          <button class="btn btn-run-news" id="news-run-btn" onclick="runNewsNow()">▶ 지금 실행</button>
        </div>

      </div>
    </div>

    <!-- ───────────────────────────── K-Startup 에이전트 ───────────────────────────── -->
    <div class="agent-card">
      <div class="agent-card-header kstartup">
        <div>
          <span class="agent-name">K-Startup 모니터링</span>
          <span class="agent-badge badge-kstartup">매일 오전 9시</span>
        </div>
        <label class="switch" title="에이전트 활성화/비활성화">
          <input type="checkbox" id="kstartup-enabled">
          <span class="slider"></span>
        </label>
      </div>

      <div class="agent-card-body">

        <!-- 기업 프로필 -->
        <div class="section-label">내 기업 프로필 (자격요건 대조용)</div>

        <div class="field">
          <label>기업명</label>
          <input type="text" id="company-name" placeholder="(주)예시기업">
        </div>
        <div class="field-row">
          <div class="field">
            <label>사업자 유형</label>
            <select id="company-type">
              <option value="">선택</option>
              <option value="법인">법인</option>
              <option value="개인사업자">개인사업자</option>
              <option value="해당없음">해당없음</option>
            </select>
          </div>
          <div class="field">
            <label>설립 연도</label>
            <input type="text" id="founded-year" placeholder="2021">
          </div>
        </div>
        <div class="field">
          <label>업종 / 산업 분야</label>
          <input type="text" id="industry" placeholder="AI, 핀테크, 제조 등">
        </div>
        <div class="field">
          <label>주요 제품 / 서비스</label>
          <textarea id="main-product" style="min-height:72px" placeholder="AI 기반 문서 자동화 SaaS 서비스"></textarea>
        </div>
        <div class="field-row">
          <div class="field">
            <label>직원 수</label>
            <input type="text" id="employees" placeholder="5">
          </div>
          <div class="field">
            <label>연간 매출 (만원)</label>
            <input type="text" id="annual-revenue" placeholder="15000">
          </div>
        </div>
        <div class="field">
          <label>사업장 소재지</label>
          <input type="text" id="location" placeholder="서울 강남구">
        </div>
        <div class="field">
          <label>보유 인증</label>
          <input type="text" id="certifications" placeholder="벤처기업, 이노비즈, ISO9001 등">
        </div>
        <div class="field">
          <label>기타 (수상, 특허, 투자 유치 등)</label>
          <textarea id="notes" style="min-height:72px" placeholder="2023년 TIPS 선정, 특허 2건 보유"></textarea>
        </div>

        <!-- K-Startup 에이전트 액션 -->
        <div class="action-row">
          <button class="btn btn-primary" onclick="saveKstartupSettings()">설정 저장</button>
          <button class="btn btn-run-kstartup" id="kstartup-run-btn" onclick="runKstartupNow()">▶ 지금 실행</button>
        </div>

      </div>
    </div>

    <!-- 하단 공통 -->
    <div class="bottom-row">
      <button class="btn btn-secondary" onclick="loadAll()">새로고침</button>
      <button class="btn btn-danger" onclick="disconnect()">연결 해제</button>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const SOURCES = ['KBS', 'MBC', 'SBS', 'JTBC', '연합뉴스'];

  function getSB() {
    return {
      url: localStorage.getItem('sb-url') || '',
      key: localStorage.getItem('sb-key') || '',
      ghToken: localStorage.getItem('gh-token') || '',
    };
  }

  async function sbFetch(path, options = {}) {
    const { url, key } = getSB();
    const safeKey = key.replace(/[^\x20-\x7E]/g, '');
    const res = await fetch(`${url}/rest/v1/${path}`, {
      ...options,
      headers: {
        apikey: safeKey,
        Authorization: `Bearer ${safeKey}`,
        'Content-Type': 'application/json',
        Prefer: 'return=representation',
        ...(options.headers || {}),
      },
    });
    if (!res.ok) throw new Error(await res.text());
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  }

  function toast(msg, isError = false) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => { el.className = 'toast'; }, 2800);
  }

  function buildSourceList(activeSources) {
    const list = document.getElementById('source-list');
    list.innerHTML = '';
    SOURCES.forEach(name => {
      const checked = activeSources.includes(name);
      const item = document.createElement('div');
      item.className = 'source-item';
      item.innerHTML = `
        <span class="source-name">${name}</span>
        <label class="switch">
          <input type="checkbox" data-source="${name}" ${checked ? 'checked' : ''}>
          <span class="slider"></span>
        </label>`;
      list.appendChild(item);
    });
  }

  async function loadNewsSettings() {
    const data = await sbFetch('agent_settings?id=eq.1');
    if (!data || data.length === 0) {
      await sbFetch('agent_settings', {
        method: 'POST',
        body: JSON.stringify({
          id: 1,
          enabled: true,
          run_every_hours: 1,
          active_sources: SOURCES,
          prompt_template: '',
          kstartup_enabled: true,
        }),
      });
      return loadNewsSettings();
    }
    const s = data[0];
    document.getElementById('news-enabled').checked = s.enabled !== false;
    document.getElementById('kstartup-enabled').checked = s.kstartup_enabled !== false;
    document.getElementById('run-every-hours').value = s.run_every_hours || 1;
    document.getElementById('prompt-template').value = s.prompt_template || '';
    buildSourceList(s.active_sources || SOURCES);
  }

  async function loadProfile() {
    const data = await sbFetch('user_profile?id=eq.1');
    if (!data || data.length === 0) return;
    const p = data[0];
    document.getElementById('company-name').value = p.company_name || '';
    document.getElementById('company-type').value = p.company_type || '';
    document.getElementById('founded-year').value = p.founded_year || '';
    document.getElementById('industry').value = p.industry || '';
    document.getElementById('main-product').value = p.main_product || '';
    document.getElementById('employees').value = p.employees || '';
    document.getElementById('annual-revenue').value = p.annual_revenue || '';
    document.getElementById('location').value = p.location || '';
    document.getElementById('certifications').value = p.certifications || '';
    document.getElementById('notes').value = p.notes || '';
  }

  async function loadAll() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('settings-panel').classList.add('hidden');
    try {
      await Promise.all([loadNewsSettings(), loadProfile()]);
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('settings-panel').classList.remove('hidden');
    } catch (e) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('setup-card').classList.remove('hidden');
      toast('연결 실패: ' + e.message, true);
    }
  }

  async function saveNewsSettings() {
    const activeSources = SOURCES.filter(name => {
      const cb = document.querySelector(`[data-source="${name}"]`);
      return cb && cb.checked;
    });
    const payload = {
      enabled: document.getElementById('news-enabled').checked,
      kstartup_enabled: document.getElementById('kstartup-enabled').checked,
      run_every_hours: parseInt(document.getElementById('run-every-hours').value),
      active_sources: activeSources,
      prompt_template: document.getElementById('prompt-template').value.trim(),
      updated_at: new Date().toISOString(),
    };
    try {
      await sbFetch('agent_settings?id=eq.1', {
        method: 'PATCH',
        body: JSON.stringify(payload),
      });
      toast('뉴스 에이전트 설정 저장 완료!');
    } catch (e) {
      toast('저장 실패: ' + e.message, true);
    }
  }

  async function saveKstartupSettings() {
    // kstartup_enabled 토글 저장
    const togglePayload = {
      kstartup_enabled: document.getElementById('kstartup-enabled').checked,
      updated_at: new Date().toISOString(),
    };
    // 프로필 저장
    const profilePayload = {
      company_name:   document.getElementById('company-name').value.trim(),
      company_type:   document.getElementById('company-type').value,
      founded_year:   parseInt(document.getElementById('founded-year').value) || null,
      industry:       document.getElementById('industry').value.trim(),
      main_product:   document.getElementById('main-product').value.trim(),
      employees:      parseInt(document.getElementById('employees').value) || null,
      annual_revenue: parseInt(document.getElementById('annual-revenue').value) || null,
      location:       document.getElementById('location').value.trim(),
      certifications: document.getElementById('certifications').value.trim(),
      notes:          document.getElementById('notes').value.trim(),
      updated_at:     new Date().toISOString(),
    };
    try {
      await Promise.all([
        sbFetch('agent_settings?id=eq.1', {
          method: 'PATCH',
          body: JSON.stringify(togglePayload),
        }),
        sbFetch('user_profile?id=eq.1', {
          method: 'PATCH',
          headers: { Prefer: 'return=minimal' },
          body: JSON.stringify(profilePayload),
        }),
      ]);
      toast('K-Startup 설정 저장 완료!');
    } catch (e) {
      toast('저장 실패: ' + e.message, true);
    }
  }

  function connect() {
    const url = document.getElementById('sb-url').value.trim().replace(/\/$/, '');
    const key = document.getElementById('sb-key').value.trim().replace(/[^\x20-\x7E]/g, '');
    const ghToken = document.getElementById('gh-token').value.trim().replace(/[^\x20-\x7E]/g, '');
    if (!url || !key) { toast('Supabase URL과 키를 입력해주세요', true); return; }
    localStorage.setItem('sb-url', url);
    localStorage.setItem('sb-key', key);
    if (ghToken) localStorage.setItem('gh-token', ghToken);
    document.getElementById('setup-card').classList.add('hidden');
    loadAll();
  }

  async function runNewsNow() {
    const { ghToken } = getSB();
    if (!ghToken) { toast('GitHub 토큰이 없습니다. 연결 해제 후 다시 입력해주세요.', true); return; }
    const btn = document.getElementById('news-run-btn');
    btn.disabled = true;
    btn.textContent = '실행 중...';
    try {
      const res = await fetch(
        'https://api.github.com/repos/hyangkk/yhmemo/actions/workflows/news-idea-agent.yml/dispatches',
        {
          method: 'POST',
          headers: {
            Accept: 'application/vnd.github+json',
            'Content-Type': 'application/json',
            Authorization: `Bearer ${ghToken}`,
          },
          body: JSON.stringify({ ref: 'main' }),
        }
      );
      if (res.status === 204) {
        toast('뉴스 에이전트 실행 요청 완료! 약 1분 후 텔레그램 확인');
      } else {
        toast('실행 실패 (' + res.status + '): ' + await res.text(), true);
      }
    } catch (e) {
      toast('오류: ' + e.message, true);
    } finally {
      btn.disabled = false;
      btn.textContent = '▶ 지금 실행';
    }
  }

  async function runKstartupNow() {
    const { ghToken } = getSB();
    if (!ghToken) { toast('GitHub 토큰이 없습니다. 연결 해제 후 다시 입력해주세요.', true); return; }
    const btn = document.getElementById('kstartup-run-btn');
    btn.disabled = true;
    btn.textContent = '실행 중...';
    try {
      const res = await fetch(
        'https://api.github.com/repos/hyangkk/yhmemo/actions/workflows/kstartup-agent.yml/dispatches',
        {
          method: 'POST',
          headers: {
            Accept: 'application/vnd.github+json',
            'Content-Type': 'application/json',
            Authorization: `Bearer ${ghToken}`,
          },
          body: JSON.stringify({ ref: 'main' }),
        }
      );
      if (res.status === 204) {
        toast('K-Startup 실행 요청 완료! 잠시 후 텔레그램 확인');
      } else {
        toast('실행 실패 (' + res.status + '): ' + await res.text(), true);
      }
    } catch (e) {
      toast('오류: ' + e.message, true);
    } finally {
      btn.disabled = false;
      btn.textContent = '▶ 지금 실행';
    }
  }

  function disconnect() {
    localStorage.removeItem('sb-url');
    localStorage.removeItem('sb-key');
    localStorage.removeItem('gh-token');
    document.getElementById('settings-panel').classList.add('hidden');
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('setup-card').classList.remove('hidden');
  }

  // 초기화
  (function init() {
    const { url, key } = getSB();
    if (url && key) {
      loadAll();
    } else {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('setup-card').classList.remove('hidden');
    }
  })();
</script>
</body>
</html>
