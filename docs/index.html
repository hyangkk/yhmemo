<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>뉴스 아이디어 에이전트 설정</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
      padding: 32px 16px;
    }

    .container { max-width: 640px; margin: 0 auto; }

    h1 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .subtitle { font-size: 14px; color: #666; margin-bottom: 28px; }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #888;
      margin-bottom: 16px;
    }

    label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; }

    input[type="text"], input[type="password"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d1d6;
      border-radius: 10px;
      font-size: 14px;
      color: #1d1d1f;
      background: #fafafa;
      outline: none;
      transition: border-color .15s;
    }
    input[type="text"]:focus, input[type="password"]:focus,
    select:focus, textarea:focus {
      border-color: #0071e3;
      background: #fff;
    }

    textarea { resize: vertical; min-height: 160px; font-family: inherit; line-height: 1.6; }

    .field { margin-bottom: 16px; }
    .field:last-child { margin-bottom: 0; }

    /* 토글 스위치 */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
    }
    .toggle-label { font-size: 15px; font-weight: 500; }
    .toggle-desc { font-size: 13px; color: #888; margin-top: 2px; }

    .switch { position: relative; width: 48px; height: 28px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; inset: 0;
      background: #d1d1d6;
      border-radius: 28px;
      cursor: pointer;
      transition: background .2s;
    }
    .slider::before {
      content: '';
      position: absolute;
      left: 3px; top: 3px;
      width: 22px; height: 22px;
      background: #fff;
      border-radius: 50%;
      transition: transform .2s;
      box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    input:checked + .slider { background: #34c759; }
    input:checked + .slider::before { transform: translateX(20px); }

    /* 소스 체크박스 */
    .source-list { display: flex; flex-direction: column; gap: 10px; }
    .source-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #f5f5f7;
      border-radius: 10px;
    }
    .source-name { font-size: 14px; font-weight: 500; }

    /* 버튼 */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 11px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity .15s, transform .1s;
    }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: #0071e3; color: #fff; width: 100%; }
    .btn-primary:hover { opacity: .9; }
    .btn-secondary {
      background: transparent;
      color: #0071e3;
      border: 1px solid #0071e3;
      width: 100%;
    }
    .btn-danger { background: transparent; color: #ff3b30; border: 1px solid #ff3b30; width: 100%; }
    .btn-run { background: #ff9500; color: #fff; width: 100%; }
    .btn-run:hover { opacity: .9; }
    .btn-run:disabled { opacity: .5; cursor: not-allowed; }

    .btn-row { display: flex; gap: 10px; }

    /* 알림 */
    .toast {
      position: fixed;
      bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #1d1d1f;
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: transform .3s, opacity .3s;
      white-space: nowrap;
      z-index: 100;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { background: #ff3b30; }

    .hint { font-size: 12px; color: #aaa; margin-top: 5px; }

    #loading {
      text-align: center;
      padding: 48px;
      color: #888;
      font-size: 15px;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="container">
  <h1>뉴스 아이디어 에이전트</h1>
  <p class="subtitle">설정 페이지 — 변경사항은 Supabase에 저장됩니다</p>

  <!-- 연결 설정 -->
  <div id="setup-card" class="card hidden">
    <div class="card-title">Supabase 연결</div>
    <div class="field">
      <label>Project URL</label>
      <input type="text" id="sb-url" placeholder="https://xxxx.supabase.co">
    </div>
    <div class="field">
      <label>Anon Key</label>
      <input type="password" id="sb-key" placeholder="sb_publishable_...">
      <p class="hint">Supabase → Settings → API Keys → sb_publishable_ 키</p>
    </div>
    <button class="btn btn-primary" onclick="connect()">연결하기</button>
  </div>

  <div id="loading">불러오는 중...</div>

  <!-- 설정 패널 -->
  <div id="settings-panel" class="hidden">

    <!-- 전체 ON/OFF -->
    <div class="card">
      <div class="card-title">전체 기능</div>
      <div class="toggle-row">
        <div>
          <div class="toggle-label">에이전트 활성화</div>
          <div class="toggle-desc">꺼두면 GitHub Actions에서 실행이 중단됩니다</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="enabled">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <!-- 실행 주기 -->
    <div class="card">
      <div class="card-title">실행 주기</div>
      <div class="field">
        <label>몇 시간마다 실행할까요?</label>
        <select id="run-every-hours">
          <option value="1">매 시간 (1시간)</option>
          <option value="2">2시간마다</option>
          <option value="3">3시간마다</option>
          <option value="6">6시간마다</option>
          <option value="12">12시간마다</option>
          <option value="24">하루 1회 (자정 UTC)</option>
        </select>
        <p class="hint">GitHub Actions는 매 시간 실행되지만, 설정한 간격에 맞지 않으면 건너뜁니다</p>
      </div>
    </div>

    <!-- 뉴스 소스 -->
    <div class="card">
      <div class="card-title">뉴스 소스</div>
      <div class="source-list" id="source-list"></div>
    </div>

    <!-- 프롬프트 -->
    <div class="card">
      <div class="card-title">AI 프롬프트 템플릿</div>
      <div class="field">
        <textarea id="prompt-template" placeholder="비워두면 기본 프롬프트를 사용합니다.

뉴스 내용이 들어갈 위치를 지정하려면 {news_block}을 사용하세요.
예시:
당신은 스타트업 투자자입니다.
아래 뉴스를 보고 투자 기회를 찾아주세요.

{news_block}

투자 관점에서 분석해주세요."></textarea>
        <p class="hint">{news_block} 위치에 수집된 뉴스가 삽입됩니다. 비워두면 기본 프롬프트 사용</p>
      </div>
    </div>

    <!-- 저장 -->
    <div class="card">
      <button class="btn btn-primary" onclick="saveSettings()" style="margin-bottom:10px">저장하기</button>
      <button class="btn btn-run" onclick="runNow()" style="margin-bottom:10px" id="run-btn">지금 실행하기</button>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="loadSettings()">새로고침</button>
        <button class="btn btn-danger" onclick="disconnect()">연결 해제</button>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const SOURCES = ['KBS', 'MBC', 'SBS', 'JTBC', '연합뉴스'];

  function getSB() {
    return {
      url: localStorage.getItem('sb-url') || '',
      key: localStorage.getItem('sb-key') || '',
    };
  }

  async function sbFetch(path, options = {}) {
    const { url, key } = getSB();
    // ASCII 범위 외 문자 제거 (HTTP 헤더 ISO-8859-1 제한 대응)
    const safeKey = key.replace(/[^\x20-\x7E]/g, '');
    const res = await fetch(`${url}/rest/v1/${path}`, {
      ...options,
      headers: {
        apikey: safeKey,
        Authorization: `Bearer ${safeKey}`,
        'Content-Type': 'application/json',
        Prefer: 'return=representation',
        ...(options.headers || {}),
      },
    });
    if (!res.ok) throw new Error(await res.text());
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  }

  function toast(msg, isError = false) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => { el.className = 'toast'; }, 2800);
  }

  function buildSourceList(activeSources) {
    const list = document.getElementById('source-list');
    list.innerHTML = '';
    SOURCES.forEach(name => {
      const checked = activeSources.includes(name);
      const item = document.createElement('div');
      item.className = 'source-item';
      item.innerHTML = `
        <span class="source-name">${name}</span>
        <label class="switch">
          <input type="checkbox" data-source="${name}" ${checked ? 'checked' : ''}>
          <span class="slider"></span>
        </label>`;
      list.appendChild(item);
    });
  }

  async function loadSettings() {
    try {
      const data = await sbFetch('agent_settings?id=eq.1');
      if (!data || data.length === 0) {
        // 첫 실행: 기본값으로 레코드 생성
        await sbFetch('agent_settings', {
          method: 'POST',
          body: JSON.stringify({
            id: 1,
            enabled: true,
            run_every_hours: 1,
            active_sources: SOURCES,
            prompt_template: '',
          }),
        });
        return loadSettings();
      }
      const s = data[0];
      document.getElementById('enabled').checked = s.enabled;
      document.getElementById('run-every-hours').value = s.run_every_hours;
      document.getElementById('prompt-template').value = s.prompt_template || '';
      buildSourceList(s.active_sources || SOURCES);
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('settings-panel').classList.remove('hidden');
    } catch (e) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('setup-card').classList.remove('hidden');
      toast('연결 실패: ' + e.message, true);
    }
  }

  async function saveSettings() {
    const activeSources = SOURCES.filter(name => {
      const cb = document.querySelector(`[data-source="${name}"]`);
      return cb && cb.checked;
    });

    const payload = {
      enabled: document.getElementById('enabled').checked,
      run_every_hours: parseInt(document.getElementById('run-every-hours').value),
      active_sources: activeSources,
      prompt_template: document.getElementById('prompt-template').value.trim(),
      updated_at: new Date().toISOString(),
    };

    try {
      await sbFetch('agent_settings?id=eq.1', {
        method: 'PATCH',
        body: JSON.stringify(payload),
      });
      toast('저장 완료!');
    } catch (e) {
      toast('저장 실패: ' + e.message, true);
    }
  }

  function connect() {
    const url = document.getElementById('sb-url').value.trim().replace(/\/$/, '');
    const key = document.getElementById('sb-key').value.trim().replace(/[^\x20-\x7E]/g, '');
    if (!url || !key) { toast('URL과 키를 모두 입력해주세요', true); return; }
    localStorage.setItem('sb-url', url);
    localStorage.setItem('sb-key', key);
    document.getElementById('setup-card').classList.add('hidden');
    document.getElementById('loading').classList.remove('hidden');
    loadSettings();
  }

  async function runNow() {
    const btn = document.getElementById('run-btn');
    btn.disabled = true;
    btn.textContent = '실행 중...';
    try {
      const res = await fetch(
        'https://api.github.com/repos/hyangkk/yhmemo/actions/workflows/news-idea-agent.yml/dispatches',
        {
          method: 'POST',
          headers: {
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ ref: 'main' }),
        }
      );
      if (res.status === 204) {
        toast('실행 요청 완료! GitHub Actions에서 진행 중입니다.');
      } else if (res.status === 401 || res.status === 404) {
        toast('GitHub 토큰이 필요합니다. 아래 안내를 확인해주세요.', true);
        alert('지금 실행하기는 GitHub Personal Access Token이 필요합니다.\n\nGitHub → Actions 탭 → 뉴스 아이디어 에이전트 → Run workflow 버튼을 직접 눌러주세요.');
      } else {
        toast('실행 실패 (' + res.status + ')', true);
      }
    } catch (e) {
      toast('오류: ' + e.message, true);
    } finally {
      btn.disabled = false;
      btn.textContent = '지금 실행하기';
    }
  }

  function disconnect() {
    localStorage.removeItem('sb-url');
    localStorage.removeItem('sb-key');
    document.getElementById('settings-panel').classList.add('hidden');
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('setup-card').classList.remove('hidden');
  }

  // 초기화
  (function init() {
    const { url, key } = getSB();
    if (url && key) {
      loadSettings();
    } else {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('setup-card').classList.remove('hidden');
    }
  })();
</script>
</body>
</html>
